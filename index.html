<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R/M TRENDING - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; }
        .sidebar { width: 260px; background: #1e293b; height: 100vh; position: fixed; left: 0; top: 0; border-right: 1px solid #334155; }
        .main-content { margin-left: 260px; padding: 20px; }
        .menu-item { padding: 15px 20px; cursor: pointer; border-left: 3px solid transparent; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { background: #334155; border-left-color: #f59e0b; color: #f59e0b; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; }
        .btn-primary { background: #f59e0b; color: #000; padding: 10px 20px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; }
        .btn-danger { background: #ef4444; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; }
        .btn-success { background: #10b981; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; }
        .hidden { display: none !important; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .modal.active { display: flex; }
        .modal-content { background: #1e293b; padding: 30px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #334155; }
        th { background: #334155; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .badge-success { background: #10b981; color: white; }
        .badge-warning { background: #f59e0b; color: black; }
        .badge-danger { background: #ef4444; color: white; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .payment-card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; margin-bottom: 15px; position: relative; }
        .payment-card.active { border-left: 4px solid #10b981; }
        .payment-card.inactive { border-left: 4px solid #ef4444; opacity: 0.7; }
        .editor-item { background: #1e293b; padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; border: 1px solid #334155; }
        .editor-item:hover { border-color: #f59e0b; }
        #loginScreen { position: fixed; inset: 0; background: #0f172a; display: flex; justify-content: center; align-items: center; z-index: 10000; }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="card" style="width: 400px; text-align: center;">
            <h1 style="color: #f59e0b; margin-bottom: 10px;">üîê Admin Panel</h1>
            <p style="color: #94a3b8; margin-bottom: 30px;">R/M TRENDING Exchange</p>
            
            <input type="password" id="adminPass" placeholder="Admin Password" value="admin123">
            <button onclick="checkLogin()" class="btn-primary" style="width: 100%; margin-top: 10px;">Login</button>
            <p style="color: #64748b; font-size: 12px; margin-top: 15px;">Default: admin123</p>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar" style="display: none;">
        <div style="padding: 20px; border-bottom: 1px solid #334155;">
            <h2 style="color: #f59e0b;">R/M TRENDING</h2>
            <p style="color: #64748b; font-size: 12px;">Admin Control Panel</p>
        </div>
        
        <div style="padding: 20px 0;">
            <div class="menu-item active" onclick="showSection('dashboard')">
                <i class="fas fa-home" style="width: 30px;"></i> Dashboard
            </div>
            <div class="menu-item" onclick="showSection('payments')">
                <i class="fas fa-credit-card" style="width: 30px;"></i> Payment Methods
            </div>
            <div class="menu-item" onclick="showSection('deposits')">
                <i class="fas fa-arrow-down" style="width: 30px;"></i> Deposits
                <span id="depositBadge" class="badge badge-danger hidden" style="margin-left: auto;">0</span>
            </div>
            <div class="menu-item" onclick="showSection('withdrawals')">
                <i class="fas fa-arrow-up" style="width: 30px;"></i> Withdrawals
            </div>
            <div class="menu-item" onclick="showSection('users')">
                <i class="fas fa-users" style="width: 30px;"></i> Users
            </div>
            <div class="menu-item" onclick="showSection('editor')">
                <i class="fas fa-edit" style="width: 30px;"></i> Website Editor
            </div>
            <div class="menu-item" onclick="showSection('nft')">
                <i class="fas fa-image" style="width: 30px;"></i> NFT Management
            </div>
            <div class="menu-item" onclick="logout()" style="color: #ef4444;">
                <i class="fas fa-sign-out-alt" style="width: 30px;"></i> Logout
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent" style="display: none;">
        
        <!-- Dashboard -->
        <div id="section-dashboard" class="section">
            <h1 style="font-size: 28px; margin-bottom: 25px;">Dashboard</h1>
            
            <div class="stats-grid">
                <div class="card">
                    <div style="color: #94a3b8; margin-bottom: 10px;">Total Users</div>
                    <div style="font-size: 32px; font-weight: bold; color: #f59e0b;" id="stat-users">0</div>
                </div>
                <div class="card">
                    <div style="color: #94a3b8; margin-bottom: 10px;">Pending Deposits</div>
                    <div style="font-size: 32px; font-weight: bold; color: #ef4444;" id="stat-pending-deps">0</div>
                </div>
                <div class="card">
                    <div style="color: #94a3b8; margin-bottom: 10px;">Today's Deposits</div>
                    <div style="font-size: 32px; font-weight: bold; color: #10b981;" id="stat-today-deps">‚Çπ0</div>
                </div>
                <div class="card">
                    <div style="color: #94a3b8; margin-bottom: 10px;">Active Payments</div>
                    <div style="font-size: 32px; font-weight: bold; color: #3b82f6;" id="stat-payments">0</div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 20px;">Recent Activity</h3>
                <div id="recent-activity">Loading...</div>
            </div>
        </div>

        <!-- Payment Methods -->
        <div id="section-payments" class="section hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h1 style="font-size: 28px;">Payment Methods</h1>
                <button onclick="openPaymentModal()" class="btn-primary">
                    <i class="fas fa-plus"></i> Add New Method
                </button>
            </div>

            <div style="margin-bottom: 20px;">
                <button onclick="filterPayments('all')" class="btn-primary" style="margin-right: 10px;">All</button>
                <button onclick="filterPayments('upi')" style="background: #334155; color: white; padding: 8px 16px; border-radius: 6px; border: none; margin-right: 10px; cursor: pointer;">UPI</button>
                <button onclick="filterPayments('bank')" style="background: #334155; color: white; padding: 8px 16px; border-radius: 6px; border: none; margin-right: 10px; cursor: pointer;">Bank</button>
                <button onclick="filterPayments('crypto')" style="background: #334155; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer;">Crypto</button>
            </div>

            <div id="payments-container">Loading payment methods...</div>
        </div>

        <!-- Deposits -->
        <div id="section-deposits" class="section hidden">
            <h1 style="font-size: 28px; margin-bottom: 25px;">Deposit Requests</h1>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Method</th>
                            <th>Amount</th>
                            <th>Details</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="deposits-table">
                        <tr><td colspan="6" style="text-align: center; padding: 40px;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Withdrawals -->
        <div id="section-withdrawals" class="section hidden">
            <h1 style="font-size: 28px; margin-bottom: 25px;">Withdrawal Requests</h1>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Method</th>
                            <th>Amount</th>
                            <th>Details</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawals-table">
                        <tr><td colspan="6" style="text-align: center; padding: 40px;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Users -->
        <div id="section-users" class="section hidden">
            <h1 style="font-size: 28px; margin-bottom: 25px;">All Users</h1>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Balance</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="users-table">
                        <tr><td colspan="6" style="text-align: center; padding: 40px;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Website Editor -->
        <div id="section-editor" class="section hidden">
            <h1 style="font-size: 28px; margin-bottom: 25px;">Website Content Editor</h1>
            <p style="color: #94a3b8; margin-bottom: 20px;">Click on any item to edit website text</p>
            <div id="editor-items">Loading...</div>
        </div>

        <!-- NFT -->
        <div id="section-nft" class="section hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h1 style="font-size: 28px;">NFT Management</h1>
                <button onclick="addNFT()" class="btn-primary">
                    <i class="fas fa-plus"></i> Add NFT
                </button>
            </div>
            <div id="nft-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">Loading...</div>
        </div>
    </div>

    <!-- Add/Edit Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Add Payment Method</h2>
            <input type="hidden" id="pay-id">
            
            <label>Type:</label>
            <select id="pay-type" onchange="changePayForm()">
                <option value="upi">UPI</option>
                <option value="bank">Bank Account</option>
                <option value="crypto">Crypto</option>
            </select>

            <div id="form-upi">
                <label>UPI ID:</label>
                <input type="text" id="upi-id" placeholder="example@upi">
                <label>Display Name:</label>
                <input type="text" id="upi-name" placeholder="Paytm / PhonePe">
                <label>QR Code URL (optional):</label>
                <input type="text" id="upi-qr" placeholder="https://...">
            </div>

            <div id="form-bank" class="hidden">
                <label>Bank Name:</label>
                <input type="text" id="bank-name" placeholder="SBI / HDFC">
                <label>Account Number:</label>
                <input type="text" id="bank-acc" placeholder="1234567890">
                <label>IFSC Code:</label>
                <input type="text" id="bank-ifsc" placeholder="SBIN0001234">
                <label>Account Holder:</label>
                <input type="text" id="bank-holder" placeholder="Name">
            </div>

            <div id="form-crypto" class="hidden">
                <label>Currency:</label>
                <select id="crypto-currency">
                    <option value="BTC">Bitcoin (BTC)</option>
                    <option value="ETH">Ethereum (ETH)</option>
                    <option value="USDT">USDT</option>
                </select>
                <label>Network:</label>
                <input type="text" id="crypto-network" placeholder="TRC20 / ERC20 / BEP20">
                <label>Wallet Address:</label>
                <input type="text" id="crypto-address" placeholder="0x...">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                <div>
                    <label>Min Amount (‚Çπ):</label>
                    <input type="number" id="pay-min" value="100">
                </div>
                <div>
                    <label>Max Amount (‚Çπ):</label>
                    <input type="number" id="pay-max" value="100000">
                </div>
            </div>

            <label style="display: flex; align-items: center; margin-top: 15px; cursor: pointer;">
                <input type="checkbox" id="pay-active" checked style="width: auto; margin-right: 10px;"> Active
            </label>

            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button onclick="savePayment()" class="btn-primary" style="flex: 1;">Save</button>
                <button onclick="closeModal('paymentModal')" style="flex: 1; background: #334155; color: white; padding: 10px; border-radius: 8px; border: none; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Content Modal -->
    <div id="contentModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Edit Content</h2>
            <input type="hidden" id="content-key">
            <label>Key:</label>
            <input type="text" id="content-key-display" disabled style="background: #334155;">
            <label>Value:</label>
            <textarea id="content-value" rows="4"></textarea>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="saveContent()" class="btn-primary" style="flex: 1;">Update</button>
                <button onclick="closeModal('contentModal')" style="flex: 1; background: #334155; color: white; padding: 10px; border-radius: 8px; border: none; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDCHUmML-3xe57TJAiZKSTHouFxIiFHGoE",
            authDomain: "etf-rm.firebaseapp.com",
            projectId: "etf-rm",
            storageBucket: "etf-rm.firebasestorage.app",
            messagingSenderId: "1013121735332",
            appId: "1:1013121735332:web:2665a687123c2a95416431"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Check Login
        function checkLogin() {
            const pass = document.getElementById('adminPass').value;
            if(pass === 'admin123') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('sidebar').style.display = 'block';
                document.getElementById('mainContent').style.display = 'block';
                initDashboard();
            } else {
                alert('Wrong Password!');
            }
        }

        function logout() {
            location.reload();
        }

        // Navigation
        function showSection(section) {
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            event.target.closest('.menu-item').classList.add('active');
            
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            document.getElementById('section-' + section).classList.remove('hidden');
            
            if(section === 'payments') loadPayments();
            if(section === 'deposits') loadDeposits();
            if(section === 'withdrawals') loadWithdrawals();
            if(section === 'users') loadUsers();
            if(section === 'editor') loadEditor();
            if(section === 'nft') loadNFTs();
        }

        // Dashboard
        function initDashboard() {
            // Real-time stats
            db.collection('users').onSnapshot(snap => {
                document.getElementById('stat-users').innerText = snap.size;
            });
            
            db.collection('paymentMethods').where('active', '==', true).onSnapshot(snap => {
                document.getElementById('stat-payments').innerText = snap.size;
            });
            
            db.collection('deposits').where('status', '==', 'pending').onSnapshot(snap => {
                document.getElementById('stat-pending-deps').innerText = snap.size;
                const badge = document.getElementById('depositBadge');
                badge.innerText = snap.size;
                badge.classList.toggle('hidden', snap.size === 0);
            });
        }

        // Payment Methods
        function loadPayments() {
            const container = document.getElementById('payments-container');
            container.innerHTML = 'Loading...';
            
            db.collection('paymentMethods').orderBy('createdAt', 'desc').get().then(snapshot => {
                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const p = doc.data();
                    const div = document.createElement('div');
                    div.className = `payment-card ${p.active ? 'active' : 'inactive'}`;
                    div.dataset.type = p.type;
                    
                    let details = '';
                    if(p.type === 'upi') details = `<strong>UPI:</strong> ${p.upiId}`;
                    else if(p.type === 'bank') details = `<strong>Acc:</strong> ${p.accountNumber} <br><strong>IFSC:</strong> ${p.ifsc}`;
                    else details = `<strong>Address:</strong> ${p.address?.substring(0,20)}...`;
                    
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <h3 style="color: #f59e0b;">${p.name}</h3>
                            <span class="badge ${p.active ? 'badge-success' : 'badge-danger'}">${p.active ? 'Active' : 'Inactive'}</span>
                        </div>
                        <p style="color: #94a3b8; font-size: 14px; margin-bottom: 10px;">${details}</p>
                        <p style="font-size: 12px; color: #64748b;">Limit: ‚Çπ${p.min} - ‚Çπ${p.max}</p>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button onclick="editPayment('${doc.id}')" class="btn-success" style="padding: 6px 12px; font-size: 12px;">Edit</button>
                            <button onclick="togglePayment('${doc.id}', ${!p.active})" class="btn-primary" style="padding: 6px 12px; font-size: 12px; background: ${p.active ? '#ef4444' : '#10b981'};">
                                ${p.active ? 'Disable' : 'Enable'}
                            </button>
                            <button onclick="deletePayment('${doc.id}')" class="btn-danger" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            });
        }

        function filterPayments(type) {
            document.querySelectorAll('.payment-card').forEach(card => {
                if(type === 'all') card.style.display = 'block';
                else card.style.display = card.dataset.type === type ? 'block' : 'none';
            });
        }

        function openPaymentModal() {
            document.getElementById('paymentModal').classList.add('active');
            document.getElementById('pay-id').value = '';
            document.getElementById('pay-type').value = 'upi';
            changePayForm();
            // Clear fields
            document.querySelectorAll('#paymentModal input:not([type="checkbox"])').forEach(i => i.value = '');
        }

        function changePayForm() {
            const type = document.getElementById('pay-type').value;
            document.getElementById('form-upi').classList.toggle('hidden', type !== 'upi');
            document.getElementById('form-bank').classList.toggle('hidden', type !== 'bank');
            document.getElementById('form-crypto').classList.toggle('hidden', type !== 'crypto');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        async function savePayment() {
            const id = document.getElementById('pay-id').value;
            const type = document.getElementById('pay-type').value;
            
            const data = {
                type,
                active: document.getElementById('pay-active').checked,
                min: parseInt(document.getElementById('pay-min').value) || 100,
                max: parseInt(document.getElementById('pay-max').value) || 100000,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if(type === 'upi') {
                data.upiId = document.getElementById('upi-id').value;
                data.name = document.getElementById('upi-name').value || 'UPI';
                data.qr = document.getElementById('upi-qr').value;
            } else if(type === 'bank') {
                data.bankName = document.getElementById('bank-name').value;
                data.accountNumber = document.getElementById('bank-acc').value;
                data.ifsc = document.getElementById('bank-ifsc').value;
                data.holder = document.getElementById('bank-holder').value;
                data.name = data.bankName + ' - ' + data.accountNumber;
            } else {
                data.currency = document.getElementById('crypto-currency').value;
                data.network = document.getElementById('crypto-network').value;
                data.address = document.getElementById('crypto-address').value;
                data.name = data.currency + ' (' + data.network + ')';
            }
            
            try {
                if(id) {
                    await db.collection('paymentMethods').doc(id).update(data);
                } else {
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('paymentMethods').add(data);
                }
                closeModal('paymentModal');
                loadPayments();
                alert('Saved successfully!');
            } catch(e) {
                alert('Error: ' + e.message);
            }
        }

        async function editPayment(id) {
            const doc = await db.collection('paymentMethods').doc(id).get();
            const p = doc.data();
            
            document.getElementById('pay-id').value = id;
            document.getElementById('pay-type').value = p.type;
            document.getElementById('pay-min').value = p.min;
            document.getElementById('pay-max').value = p.max;
            document.getElementById('pay-active').checked = p.active;
            
            changePayForm();
            
            if(p.type === 'upi') {
                document.getElementById('upi-id').value = p.upiId || '';
                document.getElementById('upi-name').value = p.name || '';
                document.getElementById('upi-qr').value = p.qr || '';
            } else if(p.type === 'bank') {
                document.getElementById('bank-name').value = p.bankName || '';
                document.getElementById('bank-acc').value = p.accountNumber || '';
                document.getElementById('bank-ifsc').value = p.ifsc || '';
                document.getElementById('bank-holder').value = p.holder || '';
            } else {
                document.getElementById('crypto-currency').value = p.currency || 'USDT';
                document.getElementById('crypto-network').value = p.network || '';
                document.getElementById('crypto-address').value = p.address || '';
            }
            
            document.getElementById('paymentModal').classList.add('active');
        }

        async function togglePayment(id, status) {
            await db.collection('paymentMethods').doc(id).update({active: status});
            loadPayments();
        }

        async function deletePayment(id) {
            if(!confirm('Delete this method?')) return;
            await db.collection('paymentMethods').doc(id).delete();
            loadPayments();
        }

        // Deposits
        function loadDeposits() {
            const tbody = document.getElementById('deposits-table');
            db.collection('deposits').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${d.userId?.substr(0,8)}...</td>
                        <td><span class="badge badge-warning">${d.type}</span></td>
                        <td>‚Çπ${d.amount}</td>
                        <td>${d.utr || d.details || '-'}</td>
                        <td><span class="badge ${d.status === 'approved' ? 'badge-success' : d.status === 'rejected' ? 'badge-danger' : 'badge-warning'}">${d.status}</span></td>
                        <td>
                            ${d.status === 'pending' ? `
                                <button onclick="approveDeposit('${doc.id}', '${d.userId}', ${d.amount})" class="btn-success" style="margin-right: 5px; padding: 4px 8px; font-size: 12px;">Approve</button>
                                <button onclick="rejectDeposit('${doc.id}')" class="btn-danger" style="padding: 4px 8px; font-size: 12px;">Reject</button>
                            ` : '-'}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        async function approveDeposit(id, userId, amount) {
            await db.collection('deposits').doc(id).update({status: 'approved'});
            // Add to user balance
            await db.collection('wallets').doc(userId).set({
                spotBalance: firebase.firestore.FieldValue.increment(amount)
            }, {merge: true});
            alert('Deposit approved and balance added!');
        }

        async function rejectDeposit(id) {
            await db.collection('deposits').doc(id).update({status: 'rejected'});
            alert('Deposit rejected!');
        }

        // Withdrawals
        function loadWithdrawals() {
            const tbody = document.getElementById('withdrawals-table');
            db.collection('withdrawals').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const w = doc.data();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${w.userId?.substr(0,8)}...</td>
                        <td>${w.method}</td>
                        <td>‚Çπ${w.amount}</td>
                        <td>${JSON.stringify(w.details)}</td>
                        <td><span class="badge ${w.status === 'completed' ? 'badge-success' : w.status === 'rejected' ? 'badge-danger' : 'badge-warning'}">${w.status}</span></td>
                        <td>
                            ${w.status === 'pending' ? `
                                <button onclick="processWithdrawal('${doc.id}', 'complete')" class="btn-success" style="margin-right: 5px; padding: 4px 8px; font-size: 12px;">Complete</button>
                                <button onclick="processWithdrawal('${doc.id}', 'reject', '${w.userId}', ${w.amount})" class="btn-danger" style="padding: 4px 8px; font-size: 12px;">Reject</button>
                            ` : '-'}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        async function processWithdrawal(id, action, userId, amount) {
            if(action === 'complete') {
                await db.collection('withdrawals').doc(id).update({status: 'completed'});
            } else {
                await db.collection('withdrawals').doc(id).update({status: 'rejected'});
                // Refund
                await db.collection('wallets').doc(userId).set({
                    spotBalance: firebase.firestore.FieldValue.increment(amount)
                }, {merge: true});
            }
            alert(action === 'complete' ? 'Withdrawal completed!' : 'Rejected and refunded!');
        }

        // Users
        function loadUsers() {
            const tbody = document.getElementById('users-table');
            db.collection('users').get().then(snapshot => {
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const u = doc.data();
                    // Get wallet
                    db.collection('wallets').doc(doc.id).get().then(w => {
                        const balance = w.exists ? w.data().spotBalance : 0;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${doc.id.substr(0,12)}...</td>
                            <td>${u.name || 'N/A'}</td>
                            <td>${u.email}</td>
                            <td>‚Çπ${balance}</td>
                            <td><span class="badge ${u.blocked ? 'badge-danger' : 'badge-success'}">${u.blocked ? 'Blocked' : 'Active'}</span></td>
                            <td>
                                <button onclick="editBalance('${doc.id}', ${balance})" class="btn-primary" style="padding: 4px 8px; font-size: 12px; margin-right: 5px;">Edit Balance</button>
                                <button onclick="toggleUser('${doc.id}', ${!u.blocked})" class="${u.blocked ? 'btn-success' : 'btn-danger'}" style="padding: 4px 8px; font-size: 12px;">${u.blocked ? 'Unblock' : 'Block'}</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
            });
        }

        async function editBalance(userId, current) {
            const newBal = prompt('Enter new balance:', current);
            if(newBal !== null) {
                await db.collection('wallets').doc(userId).set({spotBalance: parseFloat(newBal)}, {merge: true});
                loadUsers();
            }
        }

        async function toggleUser(id, block) {
            await db.collection('users').doc(id).update({blocked: block});
            loadUsers();
        }

        // Website Editor
        function loadEditor() {
            const container = document.getElementById('editor-items');
            const items = [
                {key: 'site_title', label: 'Website Title'},
                {key: 'hero_text', label: 'Hero Section Text'},
                {key: 'deposit_btn', label: 'Deposit Button Text'},
                {key: 'footer_text', label: 'Footer Text'}
            ];
            
            container.innerHTML = '';
            items.forEach(item => {
                db.collection('settings').doc(item.key).get().then(doc => {
                    const value = doc.exists ? doc.data().value : 'Not set';
                    const div = document.createElement('div');
                    div.className = 'editor-item';
                    div.innerHTML = `
                        <div style="color: #64748b; font-size: 12px; margin-bottom: 5px;">${item.label}</div>
                        <div style="font-weight: bold;">${value}</div>
                    `;
                    div.onclick = () => openContentEditor(item.key, value);
                    container.appendChild(div);
                });
            });
        }

        function openContentEditor(key, value) {
            document.getElementById('content-key').value = key;
            document.getElementById('content-key-display').value = key;
            document.getElementById('content-value').value = value;
            document.getElementById('contentModal').classList.add('active');
        }

        async function saveContent() {
            const key = document.getElementById('content-key').value;
            const value = document.getElementById('content-value').value;
            await db.collection('settings').doc(key).set({value});
            closeModal('contentModal');
            loadEditor();
            alert('Content updated!');
        }

        // NFT
        function loadNFTs() {
            const container = document.getElementById('nft-container');
            db.collection('nfts').get().then(snapshot => {
                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const n = doc.data();
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.innerHTML = `
                        <img src="${n.image || 'https://placehold.co/300x200'}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">
                        <h3>${n.name}</h3>
                        <p style="color: #f59e0b; font-weight: bold;">${n.price} ETH</p>
                        <button onclick="deleteNFT('${doc.id}')" class="btn-danger" style="width: 100%; margin-top: 10px;">Delete</button>
                    `;
                    container.appendChild(div);
                });
            });
        }

        function addNFT() {
            const name = prompt('NFT Name:');
            const price = prompt('Price in ETH:');
            const image = prompt('Image URL:');
            if(name && price) {
                db.collection('nfts').add({
                    name, price: parseFloat(price), image,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => loadNFTs());
            }
        }

        async function deleteNFT(id) {
            if(confirm('Delete this NFT?')) {
                await db.collection('nfts').doc(id).delete();
                loadNFTs();
            }
        }

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(m => {
            m.addEventListener('click', (e) => {
                if(e.target === m) m.classList.remove('active');
            });
        });
    </script>
</body>
  </html>
